<body>
    <!-- Heading -->
    <h1>Sentence Embedding Test</h1>

    <!-- for user input -->
    <form id="myForm">
        <input type="text" id="inputText">
        <button type="submit" id="submitButton">Submit</button>
    </form>

    <!-- to show the result -->
    <div id="outputDiv"></div>

    <div id="loading" style="visibility: hidden;">
        <img id="loading-image" src="https://i.gifer.com/ZKZg.gif" alt="Loading..." width="5%" />
    </div>

    <!-- to load the model -->
    <script type="module">
        let dot = (a, b) => a.map((x, i) => a[i] * b[i]).reduce((m, n) => m + n);
        let model_name = "GIST-all-MiniLM-L6-v2";

        fetch("https://raw.githubusercontent.com/avsolatorio/ai-for-data-blog/main/semantic-search/data/" + model_name + "__wdi_embeddings.json")
            .then(response => response.json())
            .then(json => window.wdi_data = json);


        // Imported the cdn of the transformers library
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.4.1';

        // get input text
        let inputText = document.getElementById('inputText');
        // get output div
        let outputDiv = document.getElementById('outputDiv');
        // get submit button
        let submitButton = document.getElementById('submitButton');

        // on submit button click
        submitButton.addEventListener('click', async (e) => {
            outputDiv.innerHTML = "";
            document.getElementById("loading").style.visibility = "visible";

            // prevent default form submission
            e.preventDefault();

            // Specifying feature-extraction task
            // https://github.com/xenova/transformers.js/blob/main/src/pipelines.js
            let extractor = await pipeline("feature-extraction", "avsolatorio/" + model_name);
            // let extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2');
            window.extractor = extractor;

            // let result = await extractor(inputText.value, { pooling: 'mean', normalize: true })
            let result = await extractor.model(extractor.tokenizer(inputText.value));

            window.dots = window.wdi_data.map(x => {
                x.sim = dot(result.sentence_embedding.data, x.embedding);
                return x;
            });

            // Sort by similarity
            window.dots.sort((a, b) => b.sim - a.sim);

            result = window.dots.map(({ embedding, ...rest }) => ({ ...rest })).slice(0, 5);

            // outputDiv.innerHTML = JSON.stringify(result.data);
            outputDiv.innerHTML = JSON.stringify(result);
            // outputDiv.innerHTML = JSON.stringify(result.sentence_embedding.data);

            window.result = result;

            document.getElementById("loading").style.visibility = "hidden";
        });
    </script>

</body>